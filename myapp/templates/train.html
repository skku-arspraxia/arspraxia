{% extends 'base.html' %}
{% load static %}
{% block mycontent %}


    <input type="hidden" class="pagetitle" value="Train"/>
    <input type="hidden" class="pageno" value="2"/>

    <div class="row g-3">
        <div class="col-sm-6">
            <label for="modelname" class="form-label">Model Name</label>
            <input type="text" class="form-control hyperparam" id="modelname" name="modelname" placeholder="모델 이름을 입력해주세요" maxlength="45" value="" />
        </div>
        <div class="col-sm-6">
            <label for="modelepoch" class="form-label">Epoch</label>
            <input type="number" class="form-control hyperparam hpnum" id="modelepoch" name="modelepoch" min="0" placeholder="에포크를 설정해주세요" value="" />
        </div>
        <div class="col-sm-6">
            <label for="modellr" class="form-label">Learning Rate</label>
            <input type="number" class="form-control hyperparam hpnum" id="modellr" name="modellr" min="0" placeholder="학습률을 설정해주세요" value="" />
        </div>
        <div class="col-sm-6">
            <label for="modelbs" class="form-label">Batch Size</label>
            <input type="number" class="form-control hyperparam hpnum" id="modelbs" name="modelbs" min="0" placeholder="배치사이즈를 설정해주세요" value="" />
        </div>
        <div class="col-md-12">
            <label for="pretrained" class="form-label">Model</label>
            <select class="form-select hyperparam" id="pretrained">
                <option hidden="" value="-1">학습 시킬 모델을 선택해주세요</option>
                <option value="0">(Pretrained) KoELECTRA-small-v3-discriminator</option>           
                {% if inference_model %}
                    <option value="-1" disabled>---------------------------------------------------------------------</option>
                    {% for model in inference_model %}
                        <option value="{{model.id}}">(Finetuned) {{ model.model_name }}</option>
                    {% endfor %}
                {% endif %}
            </select>
        </div>
        <div class="col-md-12">
            <label for="dataSrc" class="form-label">Data Set</label>
            {% if datalist %}
                <select id="dataSrc" class="form-select hyperparam">
                    <option hidden="" value="-1">데이터를 선택해주세요</option>
                        {% for data in datalist %}
                            <option value="{{forloop.counter}}">{{ data }}</option>
                        {% endfor %}    
                </select>            
            {% else %}
                <select id="dataSrc" class="form-select hyperparam" disabled> 
                    <option hidden="" value="-1">데이터가 없습니다</option>
                </select>
            {% endif %}
        </div>
        <div class="col-sm-12">
            <label for="modeldes" class="form-label">Description</label>
            <textarea class="form-control hyperparam" id="modeldes" name="modeldes" placeholder="추가 설명을 입력해주세요" maxlength="2000" value=""></textarea>
        </div>
    </div>

    <hr class="my-4">

    <button class="w-100 btn btn-primary btn-lg trainstart" type="button" onclick="startTraining(this);">Start Training</button>

    <div class="status" style="display:none;">

    </div>

    <div class="container" style="display:none;">
        <img src="{% static 'img/tmp/train.png' %}" style="width:100%;height:auto;"/>
    </div>

    <input type="hidden" class="form-control hyperparam" id="modelacc" name="modelacc" value="0.91"/>
    <input type="hidden" class="form-control hyperparam" id="modelf1" name="modelf1" value="0.92"/>
    <input type="hidden" class="form-control hyperparam" id="modelspeed" name="modelspeed" value="23.1"/>
    <input type="hidden" class="form-control hyperparam" id="modelvolume" name="modelvolume" value="48.4"/>

    <script>
        $(document).ready(function(){
            $(".hpnum").onkeydown = function(e) {
                if(!((e.keyCode > 95 && e.keyCode < 106) || (e.keyCode > 47 && e.keyCode < 58) || e.keyCode == 8)) {
                    return false;
                }
            };
        });

        function startTraining(_this){
            //$(".container").show();
            if($("#modelname").val() == ""){
                modalShow("모델 이름을 입력해주세요.");
                return;
            }
            else if($("#modelepoch").val() == "" || $("#modelepoch").val() <= 0){
                modalShow("에포크를 설정해주세요.");
                return;
            }
            else if($("#modellr").val() == "" || $("#modellr").val() <= 0){
                modalShow("학습률을 설정해주세요.");
                return;
            }
            else if($("#modelbs").val() == "" || $("#modelbs").val() <= 0){
                modalShow("배치사이즈를 설정해주세요.");
                return;
            }
            else if(parseInt($("#pretrained option:selected").val()) < 0){
                modalShow("사전 학습 모델을 선택해주세요.");
                return;
            }
            else if(parseInt($("#dataSrc option:selected").val()) < 0){
                modalShow("학습 데이터를 선택해주세요.");
                return;
            }

            $(".hyperparam, .trainstart").attr("disabled", true);
            $(_this).hide();

            var param = {
                    "task" : $("#task").val(),
                    "modelname" : $("#modelname").val(),
                    "modelepoch" : Math.round($("#modelepoch").val()),
                    "modellr" : $("#modellr").val(),
                    "modelbs" : Math.round($("#modelbs").val()),
                    "modeldes" : $("#modeldes").val(),
                    "modelacc" : $("#modelacc").val(),
                    "modelf1" : $("#modelf1").val(),
                    "modelspeed" : $("#modelspeed").val(),
                    "modelvolume" : $("#modelvolume").val(),
                    "pretrained" : parseInt($("#pretrained option:selected").val()),
                    "dataSrc" : $("#dataSrc option:selected").text(),
            };

            $(".status").show();
            
            var last_epoch = 0;
            setInterval(function(){
                $.ajax({
                    url : "/trainGetStatusAjax/",
                    type : "GET",
                    data : param,
                    dataType : "json",
                    success : function(data) {
                        var current_step = parseInt(data["current_step"]);
                        var current_epoch = parseInt(data["current_epoch"]);
                        var appendHTML = "";
                        if(current_step == 1){
                            appendHTML = "Downloading pretained model";
                        }
                        if(current_step == 2){
                            appendHTML += "Downloading pretained model finished";
                            appendHTML += "Downloading training data";
                        }
                        if(current_step == 3){
                            appendHTML += "Downloading training data finished";
                            last_epoch = current_epoch;
                            if(last_epoch != current_epoch){
                                appendHTML += "Training : Epoch " + current_epoch + " / " + Math.round($("#modelepoch").val());
                            }
                        }
                        if(current_step == 4){
                            appendHTML += "Training finished";
                            appendHTML += "Uploading model";
                        }
                        if(current_step == 5){
                            appendHTML += "Uploading finished";
                            appendHTML += "Evaluating";
                        }

                        $(".test").html(appendHTML);
                    },
                    error : function(e) {
                        modalShow("모델 학습이 실패했습니다.");
                        console.log("error :" + e.response);
                    }
                });
            },1000);

            $.ajax({
                url : "/trainStartAjax/",
                type : "GET",
                data : param,
                dataType : "json",
                success : function(data) {
                    modalShow("모델 학습이 성공적으로 완료되었습니다.");
                },
                error : function(e) {
                    $(".status").hide();
                    modalShow("모델 학습이 실패했습니다.");
                    console.log("error :" + e.response);
                }
            });
        }

    </script>

{% endblock %}